name: GCAL Sync

on:
  workflow_dispatch:
  schedule:
    # a cada 30 min
    - cron: "*/30 * * * *"

concurrency:
  group: gcal-sync
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-sync.txt

      - name: Write Google Service Account JSON
        run: |
          mkdir -p secrets_gcal
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > secrets_gcal/service-account-gcal.json

      - name: Run Sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ./secrets_gcal/service-account-gcal.json
          GOOGLE_SCOPES: https://www.googleapis.com/auth/calendar
          SYNC_LOOKBACK_DAYS: "365"
          FALLBACK_OWNER_EMAIL: felipetalin@opyta.com.br
          FORCE_PUSH_ALL: "0"
          GCAL_COLOR_MAP: "Felipe Normando:11,Yuri Martins:5,Ana Clara:2,Ismayllen Masson:7,Wilder Bento:9"
        run: |
          python scripts/gcal/sync_gcal.py
